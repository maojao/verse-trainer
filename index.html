<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>2026ì„±ê²½ê³ ì‚¬ ìš”ì ˆ í´ë¡œì¦ˆ íŠ¸ë ˆì´ë„ˆ (v7)</title>
<style>
:root{--bg:#0b0f14;--fg:#e9eef5;--muted:#94a3b8;--acc:#68b5ff;--card:#121825;--input:#0e1420;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;--border:#1f2a3a;--pill:#1a2233}
@media (prefers-color-scheme:light){
  :root{--bg:#f7fafc;--fg:#0b1220;--muted:#475569;--acc:#2563eb;--card:#ffffff;--input:#f1f5f9;--ok:#16a34a;--warn:#d97706;--err:#dc2626;--border:#e2e8f0;--pill:#eef2f7}
}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,sans-serif}
header,main,footer{max-width:980px;margin:0 auto;padding:16px}
h1{font-size:1.6rem;margin:8px 0 4px}
.toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0 16px}
button{background:var(--pill);color:var(--fg);border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer}
button:hover{border-color:var(--acc)}
select,input,textarea{background:var(--input);color:var(--fg);border:1px solid var(--border);padding:8px 10px;border-radius:10px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
.row{display:flex;gap:12px;flex-wrap:wrap}.col{flex:1 1 320px}
small.muted{color:var(--muted)} hr{border:none;border-top:1px solid var(--border);margin:16px 0}
.kbd{background:var(--pill);border:1px solid var(--border);padding:2px 6px;border-radius:6px;color:var(--muted)}
.badge{display:inline-block;background:var(--pill);border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:.8rem;color:var(--muted)}
.p{margin:6px 0}.ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
.cloze{white-space:pre-wrap;font-size:1.12rem}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.hidden{display:none}
.blank{min-width:120px;display:inline-block}
.blank input{width:100%;padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:var(--input);color:var(--fg);text-align:center}
.hints{color:var(--muted);font-size:.9rem}
.code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:var(--pill);padding:2px 6px;border-radius:6px;border:1px solid var(--border)}
.refWrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.refField{display:flex;align-items:center;gap:6px}
.refField input{width:100px}
.nextBtn{margin-top:8px}
</style>
</head>
<body>
<header class="flex-between">
  <div>
    <h1>2026 ì„±ê²½ê³ ì‚¬ ìš”ì ˆ íŠ¸ë ˆì´ë„ˆ</h1>
    <small class="muted">ì¸ì²œì œ2êµíšŒ</small>
  </div>
  <div>
    <span class="badge" id="stats">ì¹´ë“œ 0</span>
    <span class="badge" id="stat2">ì •ë‹µ 0 Â· ì˜¤ë‹µ 0</span>
  </div>
</header>

<main>
  <section class="toolbar">
    <button id="startBtn">í•™ìŠµ ì‹œì‘</button>
    <button id="stopBtn" class="hidden">ê·¸ë§Œí•˜ê¸°</button>
    <button id="listBtn">ì¹´ë“œ ëª©ë¡</button>
    <button id="exportBtn">ë°±ì—…(JSON)</button>
    <button id="resetBtn">ì „ì²´ ì´ˆê¸°í™”</button>
  </section>

  <section id="study" class="card hidden">
    <div class="flex-between">
      <div>
        <strong>ì¥ì ˆ:</strong> <span id="refView" class="code"></span>
        <span class="badge" id="weightInfo"></span>
        <span class="badge" id="modeBadge"></span>
      </div>
      <div><small class="muted">ëª¨ë“œ: <span id="modeLabel">íƒ€ì´í•‘</span></small></div>
    </div>

    <div id="refQuizArea" class="p hidden">
      <div class="refWrap">
        <div class="refField" id="bookField"><small class="muted">ì„±ê²½</small><span id="bookFixed" class="code hidden"></span><input type="text" id="bookInput" class="hidden" placeholder="ì˜ˆ: ì‹œ"/></div>
        <div class="refField" id="chapField"><small class="muted">ì¥</small><span id="chapFixed" class="code hidden"></span><input type="text" id="chapInput" class="hidden" placeholder="ì˜ˆ: 23"/></div>
        <div class="refField" id="verseField"><small class="muted">ì ˆ</small><span id="verseFixed" class="code hidden"></span><input type="text" id="verseInput" class="hidden" placeholder="ì˜ˆ: 1 ë˜ëŠ” 24-25"/></div>
      </div>
    </div>

    <div class="cloze" id="clozeHost"></div>

    <div id="typingArea" class="p">
      <div class="hints">íŒíŠ¸: <button id="hintFirst">F1(ì²«ê¸€ì)</button> <button id="hintLen">F2(ê¸¸ì´)</button> <button id="hintReveal">F3(ëœë¤ ê³µê°œ)</button> Â· <button id="switchSelf">ì…€í”„ ëª¨ë“œ</button> Â· <button id="showAnswerQuick">ì •ë‹µ ë³´ê¸°</button></div>
      <div class="p"><button id="submitBtn">ì±„ì (Enter)</button> <button id="nextBtn" class="nextBtn hidden">ë‹¤ìŒ(Enter)</button></div>
      <div id="result" class="p"></div>
    </div>

    <div id="selfArea" class="p hidden">
      <button id="showAnswer">ì •ë‹µ ë³´ê¸°</button>
      <div id="fullAnswer" class="p hidden"></div>
      <div class="p">
        <label>ì…€í”„ ì±„ì (5~1): <input type="number" min="1" max="5" value="3" id="selfScore"></label>
        <button id="selfSubmit">ê¸°ë¡</button>
        <button id="switchTyping">íƒ€ì´í•‘ ëª¨ë“œ</button>
      </div>
    </div>
  </section>

  <section id="list" class="card hidden">
    <h3>ì¹´ë“œ ëª©ë¡</h3>
    <div id="cardList"></div>
  </section>
</main>

<footer>
  <small class="muted">ì €ì¥: localStorage (cards/progress/stats) Â· ì˜¤í”„ë¼ì¸ ê°€ëŠ¥</small>
</footer>

<script>
/* ===== í‚¤ & ìƒìˆ˜ ===== */
const KEY_CARDS="bct.cards.v1";
const KEY_SRS="bct.srs.v1";
const KEY_STATS="bct.stats.v1";

const REF_QUIZ_RATE = 0.30;
// const TEXT_MASK_RATIO_NORMAL = 0.30; // â­ï¸ ì‚¬ìš© ì•ˆí•¨
const TEXT_MASK_RATIO_WHEN_REF = 0.10;

// â­ï¸ ì ì§„ì  ë‚œì´ë„ ë ˆë²¨ (ê´„í˜¸ ë¹„ìœ¨)
const MASK_LEVELS = [0.15, 0.30, 0.45, 0.60]; // 0~3 ë ˆë²¨ (ì´ 4ë‹¨ê³„)
const MAX_LEVEL = MASK_LEVELS.length - 1; // ìµœê³  ë ˆë²¨ = 3

/* ===== ê¸°ë³¸ ì¹´ë“œ ===== */
function defaultCards(){ return [
  {ref:"ë¯¼14:9", text:"ë‹¤ë§Œ ì—¬í˜¸ì™€ë¥¼ ê±°ì—­í•˜ì§€ëŠ” ë§ë¼ ë˜ ê·¸ ë•… ë°±ì„±ì„ ë‘ë ¤ì›Œí•˜ì§€ ë§ë¼ ê·¸ë“¤ì€ ìš°ë¦¬ì˜ ë¨¹ì´ë¼ ê·¸ë“¤ì˜ ë³´í˜¸ìëŠ” ê·¸ë“¤ì—ê²Œì„œ ë– ë‚¬ê³  ì—¬í˜¸ì™€ëŠ” ìš°ë¦¬ì™€ í•¨ê»˜ í•˜ì‹œëŠë‹ˆë¼ ê·¸ë“¤ì„ ë‘ë ¤ì›Œí•˜ì§€ ë§ë¼ í•˜ë‚˜"},
  {ref:"ì‹ 7:9", text:"ê·¸ëŸ°ì¦‰ ë„ˆëŠ” ì•Œë¼ ì˜¤ì§ ë„¤ í•˜ë‚˜ë‹˜ ì—¬í˜¸ì™€ëŠ” í•˜ë‚˜ë‹˜ì´ì‹œìš” ì‹ ì‹¤í•˜ì‹  í•˜ë‚˜ë‹˜ì´ì‹œë¼ ê·¸ë¥¼ ì‚¬ë‘í•˜ê³  ê·¸ì˜ ê³„ëª…ì„ ì§€í‚¤ëŠ” ìì—ê²ŒëŠ” ì²œ ëŒ€ê¹Œì§€ ê·¸ì˜ ì–¸ì•½ì„ ì´í–‰í•˜ì‹œë©° ì¸ì• ë¥¼ ë² í‘¸ì‹œë˜"},
  {ref:"ìˆ˜1:9", text:"ë‚´ê°€ ë„¤ê²Œ ëª…ë ¹í•œ ê²ƒì´ ì•„ë‹ˆëƒ ê°•í•˜ê³  ë‹´ëŒ€í•˜ë¼ ë‘ë ¤ì›Œí•˜ì§€ ë§ë©° ë†€ë¼ì§€ ë§ë¼ ë„¤ê°€ ì–´ë””ë¡œ ê°€ë“ ì§€ ë„¤ í•˜ë‚˜ë‹˜ ì—¬í˜¸ì™€ê°€ ë„ˆì™€ í•¨ê»˜ í•˜ëŠë‹ˆë¼ í•˜ì‹œë‹ˆë¼"},
  {ref:"ì‹œ8:1", text:"ì—¬í˜¸ì™€ ìš°ë¦¬ ì£¼ì—¬ ì£¼ì˜ ì´ë¦„ì´ ì˜¨ ë•…ì— ì–´ì°Œ ê·¸ë¦¬ ì•„ë¦„ë‹¤ìš´ì§€ìš” ì£¼ì˜ ì˜ê´‘ì´ í•˜ëŠ˜ì„ ë®ì—ˆë‚˜ì´ë‹¤"},
  {ref:"ì‹œ23:1", text:"ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆ ë‚´ê²Œ ë¶€ì¡±í•¨ì´ ì—†ìœ¼ë¦¬ë¡œë‹¤"},
  {ref:"ì‹œ25:6", text:"ì—¬í˜¸ì™€ì—¬ ì£¼ì˜ ê¸íœ¼í•˜ì‹¬ê³¼ ì¸ìí•˜ì‹¬ì´ ì˜ì›ë¶€í„° ìˆì—ˆì‚¬ì˜¤ë‹ˆ ì£¼ì—¬ ì´ê²ƒë“¤ì„ ê¸°ì–µí•˜ì˜µì†Œì„œ"},
  {ref:"ì‹œ34:8", text:"ë„ˆí¬ëŠ” ì—¬í˜¸ì™€ì˜ ì„ í•˜ì‹¬ì„ ë§›ë³´ì•„ ì•Œì§€ì–´ë‹¤ ê·¸ì—ê²Œ í”¼í•˜ëŠ” ìëŠ” ë³µì´ ìˆë„ë‹¤."},
  {ref:"ì‹œ37:4", text:"ë˜ ì—¬í˜¸ì™€ë¥¼ ê¸°ë»í•˜ë¼ ê·¸ê°€ ë„¤ ë§ˆìŒì˜ ì†Œì›ì„ ë„¤ê²Œ ì´ë£¨ì–´ ì£¼ì‹œë¦¬ë¡œë‹¤"},
  {ref:"ì‹œ42:5", text:"ë‚´ ì˜í˜¼ì•„ ë„¤ê°€ ì–´ì°Œí•˜ì—¬ ë‚™ì‹¬í•˜ë©° ì–´ì°Œí•˜ì—¬ ë‚´ ì†ì—ì„œ ë¶ˆì•ˆí•´ í•˜ëŠ”ê°€ ë„ˆëŠ” í•˜ë‚˜ë‹˜ê»˜ ì†Œë§ì„ ë‘ë¼ ê·¸ê°€ ë‚˜íƒ€ë‚˜ ë„ìš°ì‹¬ìœ¼ë¡œ ë§ë¯¸ì•”ì•„ ë‚´ê°€ ì—¬ì „íˆ ì°¬ì†¡í•˜ë¦¬ë¡œë‹¤"},
  {ref:"ì‹œ51:10", text:"í•˜ë‚˜ë‹˜ì´ì—¬ ë‚´ ì†ì— ì •í•œ ë§ˆìŒì„ ì°½ì¡°í•˜ì‹œê³  ë‚´ ì•ˆì— ì •ì§í•œ ì˜ì„ ìƒˆë¡­ê²Œ í•˜ì†Œì„œ"},
  {ref:"ì‹œ91:4", text:"ê·¸ê°€ ë„ˆë¥¼ ê·¸ì˜ ê¹ƒìœ¼ë¡œ ë®ìœ¼ì‹œë¦¬ë‹ˆ ë„¤ê°€ ê·¸ì˜ ë‚ ê°œ ì•„ë˜ì— í”¼í•˜ë¦¬ë¡œë‹¤ ê·¸ì˜ ì§„ì‹¤í•¨ì€ ë°©íŒ¨ì™€ ì† ë°©íŒ¨ê°€ ë˜ì‹œë‚˜ë‹ˆ"},
  {ref:"ì‹œ133:1", text:"ë³´ë¼ í˜•ì œê°€ ì—°í•©í•˜ì—¬ ë™ê±°í•¨ì´ ì–´ì°Œ ê·¸ë¦¬ ì„ í•˜ê³  ì•„ë¦„ë‹¤ìš´ê³ "},
  {ref:"ì‹œ136:26", text:"í•˜ëŠ˜ì˜ í•˜ë‚˜ë‹˜ê»˜ ê°ì‚¬í•˜ë¼ ê·¸ ì¸ìí•˜ì‹¬ì´ ì˜ì›í•¨ì´ë¡œë‹¤"},
  {ref:"ì‹œ145:17", text:"ì—¬í˜¸ì™€ê»˜ì„œëŠ” ê·¸ ëª¨ë“  í–‰ìœ„ì— ì˜ë¡œìš°ì‹œë©° ê·¸ ëª¨ë“  ì¼ì— ì€í˜œë¡œìš°ì‹œë„ë‹¤"},
  {ref:"ì 11:1", text:"ì†ì´ëŠ” ì €ìš¸ì€ ì—¬í˜¸ì™€ê»˜ì„œ ë¯¸ì›Œí•˜ì‹œë‚˜ ê³µí‰í•œ ì¶”ëŠ” ê·¸ê°€ ê¸°ë»í•˜ì‹œëŠë‹ˆë¼"},
  {ref:"ì 25:28", text:"ìê¸°ì˜ ë§ˆìŒì„ ì œì–´í•˜ì§€ ì•„ë‹ˆí•˜ëŠ” ìëŠ” ì„±ìì´ ë¬´ë„ˆì§€ê³  ì„±ë²½ì´ ì—†ëŠ” ê²ƒê³¼ ê°™ìœ¼ë‹ˆë¼"},
  {ref:"ë§ˆ5:8", text:"ë§ˆìŒì´ ì²­ê²°í•œ ìëŠ” ë³µì´ ìˆë‚˜ë‹ˆ ê·¸ë“¤ì´ í•˜ë‚˜ë‹˜ì„ ë³¼ ê²ƒì„ì´ìš”"},
  {ref:"ë§ˆ7:15", text:"ê±°ì§“ ì„ ì§€ìë“¤ì„ ì‚¼ê°€ë¼ ì–‘ì˜ ì˜·ì„ ì…ê³  ë„ˆí¬ì—ê²Œ ë‚˜ì•„ì˜¤ë‚˜ ì†ì—ëŠ” ë…¸ëµì§ˆí•˜ëŠ” ì´ë¦¬ë¼"},
  {ref:"ë§ˆ11:25", text:"ê·¸ ë•Œì— ì˜ˆìˆ˜ê»˜ì„œ ëŒ€ë‹µí•˜ì—¬ ì´ë¥´ì‹œë˜ ì²œì§€ì˜ ì£¼ì¬ì´ì‹  ì•„ë²„ì§€ì—¬ ì´ê²ƒì„ ì§€í˜œë¡­ê³  ìŠ¬ê¸° ìˆëŠ” ìë“¤ì—ê²ŒëŠ” ìˆ¨ê¸°ì‹œê³  ì–´ë¦° ì•„ì´ë“¤ì—ê²ŒëŠ” ë‚˜íƒ€ë‚´ì‹¬ì„ ê°ì‚¬í•˜ë‚˜ì´ë‹¤"},
  {ref:"ë§ˆ11:29", text:"ë‚˜ëŠ” ë§ˆìŒì´ ì˜¨ìœ í•˜ê³  ê²¸ì†í•˜ë‹ˆ ë‚˜ì˜ ë©ì—ë¥¼ ë©”ê³  ë‚´ê²Œ ë°°ìš°ë¼ ê·¸ë¦¬í•˜ë©´ ë„ˆí¬ ë§ˆìŒì´ ì‰¼ì„ ì–»ìœ¼ë¦¬ë‹ˆ"},
  {ref:"ëˆ…6:36", text:"ë„ˆí¬ ì•„ë²„ì§€ì˜ ìë¹„ë¡œìš°ì‹¬ ê°™ì´ ë„ˆí¬ë„ ìë¹„ë¡œìš´ ìê°€ ë˜ë¼"},
  {ref:"ìš”10:15", text:"ì•„ë²„ì§€ê»˜ì„œ ë‚˜ë¥¼ ì•„ì‹œê³  ë‚´ê°€ ì•„ë²„ì§€ë¥¼ ì•„ëŠ” ê²ƒ ê°™ìœ¼ë‹ˆ ë‚˜ëŠ” ì–‘ì„ ìœ„í•˜ì—¬ ëª©ìˆ¨ì„ ë²„ë¦¬ë…¸ë¼"},
  {ref:"ìš”12:24", text:"ë‚´ê°€ ì§„ì‹¤ë¡œ ì§„ì‹¤ë¡œ ë„ˆí¬ì—ê²Œ ì´ë¥´ë…¸ë‹ˆ í•œ ì•Œì˜ ë°€ì´ ë•…ì— ë–¨ì–´ì ¸ ì£½ì§€ ì•„ë‹ˆí•˜ë©´ í•œ ì•Œ ê·¸ëŒ€ë¡œ ìˆê³  ì£½ìœ¼ë©´ ë§ì€ ì—´ë§¤ë¥¼ ë§ºëŠë‹ˆë¼"},
  {ref:"í–‰4:35", text:"ì‚¬ë„ë“¤ì˜ ë°œ ì•ì— ë‘ë§¤ ê·¸ë“¤ì´ ê° ì‚¬ëŒì˜ í•„ìš”ë¥¼ ë”°ë¼ ë‚˜ëˆ„ì–´ ì¤Œì´ë¼"},
  {ref:"í–‰10:2", text:"ê·¸ê°€ ê²½ê±´í•˜ì—¬ ì˜¨ ì§‘ì•ˆê³¼ ë”ë¶ˆì–´ í•˜ë‚˜ë‹˜ì„ ê²½ì™¸í•˜ë©° ë°±ì„±ì„ ë§ì´ êµ¬ì œí•˜ê³  í•˜ë‚˜ë‹˜ê»˜ í•­ìƒ ê¸°ë„í•˜ë”ë‹ˆ"},
  {ref:"ë¡¬12:15", text:"ì¦ê±°ì›Œí•˜ëŠ” ìë“¤ê³¼ í•¨ê»˜ ì¦ê±°ì›Œí•˜ê³  ìš°ëŠ” ìë“¤ê³¼ í•¨ê»˜ ìš¸ë¼"},
  {ref:"ë¡¬12:18", text:"í•  ìˆ˜ ìˆê±°ë“  ë„ˆí¬ë¡œì„œëŠ” ëª¨ë“  ì‚¬ëŒê³¼ ë”ë¶ˆì–´ í™”ëª©í•˜ë¼"},
  {ref:"ë¡¬14:1", text:"ë¯¿ìŒì´ ì—°ì•½í•œ ìë¥¼ ë„ˆí¬ê°€ ë°›ë˜ ê·¸ì˜ ì˜ê²¬ì„ ë¹„íŒí•˜ì§€ ë§ë¼"},
  {ref:"ê³ ì „4:2", text:"ê·¸ë¦¬ê³  ë§¡ì€ ìë“¤ì—ê²Œ êµ¬í•  ê²ƒì€ ì¶©ì„±ì´ë‹ˆë¼"},
  {ref:"ê³ ì „9:23", text:"ë‚´ê°€ ë³µìŒì„ ìœ„í•˜ì—¬ ëª¨ë“  ê²ƒì„ í–‰í•¨ì€ ë³µìŒì— ì°¸ì—¬í•˜ê³ ì í•¨ì´ë¼"},
  {ref:"ê³ ì „10:31", text:"ê·¸ëŸ°ì¦‰ ë„ˆí¬ê°€ ë¨¹ë“ ì§€ ë§ˆì‹œë“ ì§€ ë¬´ì—‡ì„ í•˜ë“ ì§€ ë‹¤ í•˜ë‚˜ë‹˜ì˜ ì˜ê´‘ì„ ìœ„í•˜ì—¬ í•˜ë¼"},
  {ref:"ê³ ì „14:40", text:"ëª¨ë“  ê²ƒì„ í’ˆìœ„ ìˆê²Œ í•˜ê³  ì§ˆì„œ ìˆê²Œ í•˜ë¼"},
  {ref:"ê³ ì „15:57", text:"ìš°ë¦¬ ì£¼ ì˜ˆìˆ˜ ê·¸ë¦¬ìŠ¤ë„ë¡œ ë§ë¯¸ì•”ì•„ ìš°ë¦¬ì—ê²Œ ìŠ¹ë¦¬ë¥¼ ì£¼ì‹œëŠ” í•˜ë‚˜ë‹˜ê»˜ ê°ì‚¬í•˜ë…¸ë‹ˆ"},
  {ref:"ê³ í›„1:4", text:"ìš°ë¦¬ì˜ ëª¨ë“  í™˜ë‚œ ì¤‘ì—ì„œ ìš°ë¦¬ë¥¼ ìœ„ë¡œí•˜ì‚¬ ìš°ë¦¬ë¡œ í•˜ì—¬ê¸ˆ í•˜ë‚˜ë‹˜ê»˜ ë°›ëŠ” ìœ„ë¡œë¡œì¨ ëª¨ë“  í™˜ë‚œ ì¤‘ì— ìˆëŠ” ìë“¤ì„ ëŠ¥íˆ ìœ„ë¡œí•˜ê²Œ í•˜ì‹œëŠ” ì´ì‹œë¡œë‹¤"},
  {ref:"ì—¡2:10", text:"ìš°ë¦¬ëŠ” ê·¸ê°€ ë§Œë“œì‹  ë°”ë¼ ê·¸ë¦¬ìŠ¤ë„ ì˜ˆìˆ˜ ì•ˆì—ì„œ ì„ í•œ ì¼ì„ ìœ„í•˜ì—¬ ì§€ìœ¼ì‹¬ì„ ë°›ì€ ìë‹ˆ ì´ ì¼ì€ í•˜ë‚˜ë‹˜ì´ ì „ì— ì˜ˆë¹„í•˜ì‚¬ ìš°ë¦¬ë¡œ ê·¸ ê°€ìš´ë°ì„œ í–‰í•˜ê²Œ í•˜ë ¤ í•˜ì‹¬ì´ë‹ˆë¼"},
  {ref:"ì—¡2:19", text:"ê·¸ëŸ¬ë¯€ë¡œ ì´ì œë¶€í„° ë„ˆí¬ëŠ” ì™¸ì¸ë„ ì•„ë‹ˆìš” ë‚˜ê·¸ë„¤ë„ ì•„ë‹ˆìš” ì˜¤ì§ ì„±ë„ë“¤ê³¼ ë™ì¼í•œ ì‹œë¯¼ì´ìš” í•˜ë‚˜ë‹˜ì˜ ê¶Œì†ì´ë¼"},
  {ref:"ë¹Œ1:10", text:"ë„ˆí¬ë¡œ ì§€ê·¹íˆ ì„ í•œ ê²ƒì„ ë¶„ë³„í•˜ë©° ë˜ ì§„ì‹¤í•˜ì—¬ í—ˆë¬¼ ì—†ì´ ê·¸ë¦¬ìŠ¤ë„ì˜ ë‚ ê¹Œì§€ ì´ë¥´ê³ "},
  {ref:"ë¹Œ1:18", text:"ê·¸ëŸ¬ë©´ ë¬´ì—‡ì´ëƒ ê²‰ì¹˜ë ˆë¡œ í•˜ë‚˜ ì°¸ìœ¼ë¡œ í•˜ë‚˜ ë¬´ìŠ¨ ë°©ë„ë¡œ í•˜ë“ ì§€ ì „íŒŒë˜ëŠ” ê²ƒì€ ê·¸ë¦¬ìŠ¤ë„ë‹ˆ ì´ë¡œì¨ ë‚˜ëŠ” ê¸°ë»í•˜ê³  ë˜í•œ ê¸°ë»í•˜ë¦¬ë¼"},
  {ref:"ë¹Œ2:3", text:"ì•„ë¬´ ì¼ì—ë“ ì§€ ë‹¤íˆ¼ì´ë‚˜ í—ˆì˜ìœ¼ë¡œ í•˜ì§€ ë§ê³  ì˜¤ì§ ê²¸ì†í•œ ë§ˆìŒìœ¼ë¡œ ê°ê° ìê¸°ë³´ë‹¤ ë‚¨ì„ ë‚«ê²Œ ì—¬ê¸°ê³ "},
  {ref:"ë¹Œ2:8", text:"ì‚¬ëŒì˜ ëª¨ì–‘ìœ¼ë¡œ ë‚˜íƒ€ë‚˜ì‚¬ ìê¸°ë¥¼ ë‚®ì¶”ì‹œê³  ì£½ê¸°ê¹Œì§€ ë³µì¢…í•˜ì…¨ìœ¼ë‹ˆ ê³§ ì‹­ìê°€ì— ì£½ìœ¼ì‹¬ì´ë¼"},
  {ref:"ë¹Œ4:8", text:"ëìœ¼ë¡œ í˜•ì œë“¤ì•„ ë¬´ì—‡ì—ë“ ì§€ ì°¸ë˜ë©° ë¬´ì—‡ì—ë“ ì§€ ê²½ê±´í•˜ë©° ë¬´ì—‡ì—ë“ ì§€ ì˜³ìœ¼ë©° ë¬´ì—‡ì—ë“ ì§€ ì •ê²°í•˜ë©° ë¬´ì—‡ì—ë“ ì§€ ì‚¬ë‘ ë°›ì„ ë§Œí•˜ë©° ë¬´ì—‡ì—ë“ ì§€ ì¹­ì°¬ ë°›ì„ ë§Œí•˜ë©° ë¬´ìŠ¨ ë•ì´ ìˆë“ ì§€ ë¬´ìŠ¨ ê¸°ë¦¼ì´ ìˆë“ ì§€ ì´ê²ƒë“¤ì„ ìƒê°í•˜ë¼"},
  {ref:"ë¹Œ4:13", text:"ë‚´ê²Œ ëŠ¥ë ¥ ì£¼ì‹œëŠ” ì ì•ˆì—ì„œ ë‚´ê°€ ëª¨ë“  ê²ƒì„ í•  ìˆ˜ ìˆëŠë‹ˆë¼"},
  {ref:"ê³¨3:13", text:"ëˆ„ê°€ ëˆ„êµ¬ì—ê²Œ ë¶ˆë§Œì´ ìˆê±°ë“  ì„œë¡œ ìš©ë‚©í•˜ì—¬ í”¼ì°¨ ìš©ì„œí•˜ë˜ ì£¼ê»˜ì„œ ë„ˆí¬ë¥¼ ìš©ì„œí•˜ì‹  ê²ƒ ê°™ì´ ë„ˆí¬ë„ ê·¸ë¦¬í•˜ê³ "},
  {ref:"ê³¨3:22", text:"ì¢…ë“¤ì•„ ëª¨ë“  ì¼ì— ìœ¡ì‹ ì˜ ìƒì „ë“¤ì—ê²Œ ìˆœì¢…í•˜ë˜ ì‚¬ëŒì„ ê¸°ì˜ê²Œ í•˜ëŠ” ìì™€ ê°™ì´ ëˆˆê°€ë¦¼ë§Œ í•˜ì§€ ë§ê³  ì˜¤ì§ ì£¼ë¥¼ ë‘ë ¤ì›Œí•˜ì—¬ ì„±ì‹¤í•œ ë§ˆìŒìœ¼ë¡œ í•˜ë¼"},
  {ref:"ë”¤ì „6:8", text:"ìš°ë¦¬ê°€ ë¨¹ì„ ê²ƒê³¼ ì…ì„ ê²ƒì´ ìˆì€ì¦‰ ì¡±í•œ ì¤„ë¡œ ì•Œ ê²ƒì´ë‹ˆë¼"},
  {ref:"ë”¤í›„4:2", text:"ë„ˆëŠ” ë§ì”€ì„ ì „íŒŒí•˜ë¼ ë•Œë¥¼ ì–»ë“ ì§€ ëª» ì–»ë“ ì§€ í•­ìƒ í˜ì“°ë¼ ë²”ì‚¬ì— ì˜¤ë˜ ì°¸ìŒê³¼ ê°€ë¥´ì¹¨ìœ¼ë¡œ ê²½ì±…í•˜ë©° ê²½ê³„í•˜ë©° ê¶Œí•˜ë¼"},
  {ref:"ë”›2:7", text:"ë²”ì‚¬ì— ë„¤ ìì‹ ì´ ì„ í•œ ì¼ì˜ ë³¸ì„ ë³´ì´ë©° êµí›ˆì— ë¶€íŒ¨í•˜ì§€ ì•„ë‹ˆí•¨ê³¼ ë‹¨ì •í•¨ê³¼"},
  {ref:"íˆ10:24-25", text:"ì„œë¡œ ëŒì•„ë³´ì•„ ì‚¬ë‘ê³¼ ì„ í–‰ì„ ê²©ë ¤í•˜ë©° ëª¨ì´ê¸°ë¥¼ íí•˜ëŠ” ì–´ë–¤ ì‚¬ëŒë“¤ì˜ ìŠµê´€ê³¼ ê°™ì´ í•˜ì§€ ë§ê³  ì˜¤ì§ ê¶Œí•˜ì—¬ ê·¸ ë‚ ì´ ê°€ê¹Œì›€ì„ ë³¼ìˆ˜ë¡ ë”ìš± ê·¸ë¦¬í•˜ì"},
  {ref:"íˆ13:2", text:"ì†ë‹˜ ëŒ€ì ‘í•˜ê¸°ë¥¼ ìŠì§€ ë§ë¼ ì´ë¡œì¨ ë¶€ì§€ì¤‘ì— ì²œì‚¬ë“¤ì„ ëŒ€ì ‘í•œ ì´ë“¤ì´ ìˆì—ˆëŠë‹ˆë¼"},
  {ref:"íˆ13:8", text:"ì˜ˆìˆ˜ ê·¸ë¦¬ìŠ¤ë„ëŠ” ì–´ì œë‚˜ ì˜¤ëŠ˜ì´ë‚˜ ì˜ì›í† ë¡ ë™ì¼í•˜ì‹œë‹ˆë¼"},
  {ref:"ì•½1:5", text:"ë„ˆí¬ ì¤‘ì— ëˆ„êµ¬ë“ ì§€ ì§€í˜œê°€ ë¶€ì¡±í•˜ê±°ë“  ëª¨ë“  ì‚¬ëŒì—ê²Œ í›„íˆ ì£¼ì‹œê³  ê¾¸ì§–ì§€ ì•„ë‹ˆí•˜ì‹œëŠ” í•˜ë‚˜ë‹˜ê»˜ êµ¬í•˜ë¼ ê·¸ë¦¬í•˜ë©´ ì£¼ì‹œë¦¬ë¼"},
  {ref:"ì•½1:19", text:"ë‚´ ì‚¬ë‘í•˜ëŠ” í˜•ì œë“¤ì•„ ë„ˆí¬ê°€ ì•Œì§€ë‹ˆ ì‚¬ëŒë§ˆë‹¤ ë“£ê¸°ëŠ” ì†íˆ í•˜ê³  ë§í•˜ê¸°ëŠ” ë”ë”” í•˜ë©° ì„±ë‚´ê¸°ë„ ë”ë”” í•˜ë¼"},
  {ref:"ë²§ì „1:16", text:"ê¸°ë¡ë˜ì—ˆìœ¼ë˜ ë‚´ê°€ ê±°ë£©í•˜ë‹ˆ ë„ˆí¬ë„ ê±°ë£©í• ì§€ì–´ë‹¤ í•˜ì…¨ëŠë‹ˆë¼"},
  {ref:"ë²§ì „2:17", text:"ë­‡ ì‚¬ëŒì„ ê³µê²½í•˜ë©° í˜•ì œë¥¼ ì‚¬ë‘í•˜ë©° í•˜ë‚˜ë‹˜ì„ ë‘ë ¤ì›Œí•˜ë©° ì™•ì„ ì¡´ëŒ€í•˜ë¼"},
  {ref:"ë²§í›„1:4", text:"ì´ë¡œì¨ ê·¸ ë³´ë°°ë¡­ê³  ì§€ê·¹íˆ í° ì•½ì†ì„ ìš°ë¦¬ì—ê²Œ ì£¼ì‚¬ ì´ ì•½ì†ìœ¼ë¡œ ë§ë¯¸ì•”ì•„ ë„ˆí¬ê°€ ì •ìš• ë•Œë¬¸ì— ì„¸ìƒì—ì„œ ì©ì–´ì§ˆ ê²ƒì„ í”¼í•˜ì—¬ ì‹ ì„±í•œ ì„±í’ˆì— ì°¸ì—¬í•˜ëŠ” ìê°€ ë˜ê²Œ í•˜ë ¤ í•˜ì…¨ëŠë‹ˆë¼"},
  {ref:"ë²§í›„3:9", text:"ì£¼ì˜ ì•½ì†ì€ ì–´ë–¤ ì´ë“¤ì´ ë”ë””ë‹¤ê³  ìƒê°í•˜ëŠ” ê²ƒ ê°™ì´ ë”ë”˜ ê²ƒì´ ì•„ë‹ˆë¼ ì˜¤ì§ ì£¼ê»˜ì„œëŠ” ë„ˆí¬ë¥¼ ëŒ€í•˜ì—¬ ì˜¤ë˜ ì°¸ìœ¼ì‚¬ ì•„ë¬´ë„ ë©¸ë§í•˜ì§€ ì•„ë‹ˆí•˜ê³  ë‹¤ íšŒê°œí•˜ê¸°ì— ì´ë¥´ê¸°ë¥¼ ì›í•˜ì‹œëŠë‹ˆë¼"},
  {ref:"ìš”ì¼4:16", text:"í•˜ë‚˜ë‹˜ì´ ìš°ë¦¬ë¥¼ ì‚¬ë‘í•˜ì‹œëŠ” ì‚¬ë‘ì„ ìš°ë¦¬ê°€ ì•Œê³  ë¯¿ì—ˆë…¸ë‹ˆ í•˜ë‚˜ë‹˜ì€ ì‚¬ë‘ì´ì‹œë¼ ì‚¬ë‘ ì•ˆì— ê±°í•˜ëŠ” ìëŠ” í•˜ë‚˜ë‹˜ ì•ˆì— ê±°í•˜ê³  í•˜ë‚˜ë‹˜ë„ ê·¸ì˜ ì•ˆì— ê±°í•˜ì‹œëŠë‹ˆë¼"}
];}

/* ===== ì €ì¥ ===== */
function load(key, def){ try{ const r=localStorage.getItem(key); return r?JSON.parse(r):def; }catch(e){return def}}
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

let CARDS = load(KEY_CARDS, null); if(!CARDS){ CARDS=defaultCards(); save(KEY_CARDS, CARDS); }
let SRS   = load(KEY_SRS, {});
let STATS = load(KEY_STATS, {});

function today(){ return new Date().toISOString().slice(0,10); }
function normalize(s){ return (s||"").replace(/\s+/g,"").replace(/[^\wê°€-í£:0-9\-]/g,"").toLowerCase(); }
function updateHeader(){
  document.getElementById("stats").textContent = `ì¹´ë“œ ${CARDS.length}`;
  let c=0,w=0; Object.values(STATS).forEach(s=>{ c+=s.correct||0; w+=s.wrong||0; });
  document.getElementById("stat2").textContent = `ì •ë‹µ ${c} Â· ì˜¤ë‹µ ${w}`;
}
updateHeader();

// â­ï¸ [ìš”ì²­ 2] ì˜¤ë‹µ í•˜ì´ë¼ì´íŠ¸ë¥¼ ìœ„í•œ êµ¬ì ˆ ì¬êµ¬ì„± í—¬í¼
function reconstructVerse(maskedText, correctAnswers, inputElements) {
  let html = "";
  const tempDiv = document.createElement("div"); // XSS ë°©ì§€ë¥¼ ìœ„í•´
  const parts = maskedText.split("(ã€€ã€€ã€€)");
  
  parts.forEach((seg, i) => {
    tempDiv.textContent = seg;
    html += tempDiv.innerHTML; // í…ìŠ¤íŠ¸ë¥¼ HTML-safeí•˜ê²Œ ì¶”ê°€
    
    if (i < correctAnswers.length) {
      const expected = correctAnswers[i];
      const actual = inputElements[i] ? inputElements[i].value.trim() : "";
      const isOk = normalize(expected) === normalize(actual); // 'normalize'ëŠ” ì „ì—­ì— ì •ì˜ë¨
      
      tempDiv.textContent = expected;
      const safeExpected = tempDiv.innerHTML;
      tempDiv.textContent = actual;
      const safeActual = tempDiv.innerHTML;

      if (isOk) {
        // ë§ì€ ë‹µ
        html += `<span class="ok" style="font-weight:bold; color:var(--ok);">${safeExpected}</span>`;
      } else {
        // í‹€ë¦° ë‹µ
        html += `<span class="err" title="ì…ë ¥: ${safeActual || 'ì—†ìŒ'}" style="font-weight:bold; color:var(--err); text-decoration: underline; text-decoration-color: var(--err);">${safeExpected}</span>`;
      }
    }
  });
  return html;
}


/* ===== í´ë¡œì¦ˆ ìƒì„± ===== */
const STOP = new Set(["ë“ ì§€","ì€","ëŠ”","ì´","ê°€","ì„","ë¥¼","ì—","ì—ì„œ","ì—ê²Œ","ì˜","ê³¼","ì™€","ë„","ë§Œ","ìœ¼ë¡œ","ë¡œ","ê»˜","ë³´ë‹¤","ê¹Œì§€","ë¶€í„°","ì´ë‚˜","ë‚˜","ë¼","ë‹¤","í•¨","ê²ƒ","ìˆ˜","í•˜ë‹¤","ìˆë‹¤","ì—†ë‹¤","ê°™ë‹¤","í–ˆë‹¤","í•˜ë©°","í•˜ê³ ","ë˜ë‹¤","í–ˆë‹¤ê°€","í•œë‹¤"]);
function tokenize(s){ return s.trim().split(/\s+/); }
function extractManual(text){ const answers=[],parts=[]; let i=0; while(i<text.length){ const s=text.indexOf("{{",i); if(s<0){ parts.push(text.slice(i)); break;} parts.push(text.slice(i,s)); const e=text.indexOf("}}",s+2); if(e<0){ parts.push(text.slice(s)); break;} const ans=text.slice(s+2,e); answers.push(ans); parts.push("(ã€€ã€€ã€€)"); i=e+2;} return {masked:parts.join(""), answers}; }
function autoMask(text, ratio=0.3, minLen=2, level=0){
  const toks=tokenize(text), elig=[];
  toks.forEach((tok,idx)=>{ 
    const clean=tok.replace(/[^\wê°€-í£]/g,""); 
    if(clean.length<minLen) return; 
    if(STOP.has(clean)) return; 
    if(/^\d+$/.test(clean)) return; 
    const kor=(clean.match(/[ê°€-í£]/g)||[]).length; 
    const score=kor*2+clean.length; 
    elig.push({score,idx}); 
  });
  if(!elig.length) return {masked:text,answers:[]};

  const count=Math.max(1,Math.round(toks.length*ratio));

  elig.sort((a,b)=>b.score-a.score);

  let pool_multiplier;
  if (level === 0) pool_multiplier = 1.5;
  else if (level === 1) pool_multiplier = 2.0;
  else if (level === 2) pool_multiplier = 3.0;
  else pool_multiplier = 100;

  let pool_size = Math.round(count * pool_multiplier);
  pool_size = Math.min(elig.length, Math.max(pool_size, count + 2));

  const pool = elig.slice(0, pool_size).sort(() => Math.random() - 0.5);

  const pick = pool.slice(0, count).map(o => o.idx).sort((a,b) => a - b);

  const answers=[]; 
  const out=toks.map((t,i)=> pick.includes(i)?(answers.push(t.replace(/[^\wê°€-í£]/g,"")),"(ã€€ã€€ã€€)"):t );
  return {masked:out.join(" "), answers};
}
function makeCloze(text, ratio, level=0){ return (text.includes("{{")&&text.includes("}}"))?extractManual(text):autoMask(text, ratio, 2, level); }

/* ===== ê°€ì¤‘ì¹˜ ëœë¤ (â­ï¸ ìˆ˜ì •ë¨) ===== */
const BETA=0.7;
function weightOf(ref){ const s=STATS[ref]||{correct:0}; return Math.max(0.05, 1/Math.pow(1+(s.correct||0), BETA)); }

// â­ï¸ ìˆ˜ì •ëœ í•¨ìˆ˜: due ë‚ ì§œë¥¼ í™•ì¸
function pickWeighted(){
  const now = today();

  // 1. ë³µìŠµì¼ì´ ë„ë˜í•œ(due) ì¹´ë“œë§Œ í•„í„°ë§
  const dueCards = CARDS.filter(c => {
    const srs = SRS[c.ref];
    // ìƒˆ ì¹´ë“œ(srs ì •ë³´ ì—†ìŒ) ë˜ëŠ” ë³µìŠµì¼ì´ ì˜¤ëŠ˜/ê³¼ê±°ì¸ ì¹´ë“œ
    if (!srs || !srs.due) return true; 
    return srs.due <= now;
  });

  // 2. ê³µë¶€í•  ì¹´ë“œê°€ ì—†ìœ¼ë©´, ì „ì²´ ì¹´ë“œ í’€ì—ì„œ í•˜ë‚˜ ì„ íƒ (ë³µìŠµ)
  //    ê³µë¶€í•  ì¹´ë“œê°€ ìˆìœ¼ë©´, 'dueCards' í’€ì—ì„œ ì„ íƒ
  const pool = dueCards.length > 0 ? dueCards : CARDS;

  // 3. ì„ íƒëœ í’€(pool) ì•ˆì—ì„œ ê¸°ì¡´ì˜ ê°€ì¤‘ì¹˜ ëœë¤ ë¡œì§ ì‹¤í–‰
  const w = pool.map(c => weightOf(c.ref)), sum=w.reduce((a,b)=>a+b,0);
  let r=Math.random()*sum;
  for(let i=0;i<pool.length;i++){
    r-=w[i];
    if(r<=0) return {card:pool[i], weight:w[i]};
  }
  return {card:pool[pool.length-1], weight:w[w.length-1]};
}

/* ===== ì°¸ì¡° íŒŒì‹± ===== */
function parseRef(ref){ const m=ref.match(/^([^\d:]+)(\d+):(.+)$/); if(!m) return {book:ref, chap:"", verse:""}; return {book:m[1], chap:String(m[2]), verse:m[3]}; }
function normalizeRef(s){ return normalize(s); }

/* ===== UI ===== */
const elStudy=document.getElementById("study");
const elList=document.getElementById("list");
const elRefView=document.getElementById("refView");
const elWeightInfo=document.getElementById("weightInfo");
const elModeBadge=document.getElementById("modeBadge");
const elModeLabel=document.getElementById("modeLabel");
const elClozeHost=document.getElementById("clozeHost");
const elResult=document.getElementById("result");

const elRefQuizArea=document.getElementById("refQuizArea");
const elBookFixed=document.getElementById("bookFixed");
const elChapFixed=document.getElementById("chapFixed");
const elVerseFixed=document.getElementById("verseFixed");
const elBookInput=document.getElementById("bookInput");
const elChapInput=document.getElementById("chapInput");
const elVerseInput=document.getElementById("verseInput");

const elNextBtn=document.getElementById("nextBtn");

function show(section){ [elStudy, elList].forEach(s=>s.classList.add("hidden")); if(section) section.classList.remove("hidden"); }

/* ===== ìƒíƒœ ===== */
let running=false;
let current=null;
let hintUsed=false;
let waitingNext=false;

/* ===== ë³´ì¡° ===== */
function advanceNext(){
  if(waitingNext){
    waitingNext=false;
    elNextBtn.classList.add("hidden");
    nextCard();
  }
}

/* ===== ë ˆí¼ëŸ°ìŠ¤ ì…ë ¥ ë„¤ë¹„ ===== */
function refFieldsMaskedOrder() {
  const order = [];
  if (current && current.refMask) {
    if (current.refMask.book) order.push(elBookInput);
    if (current.refMask.chap) order.push(elChapInput);
    if (current.refMask.verse) order.push(elVerseInput);
  }
  return order;
}
function focusFirstClozeOrGrade() {
  if (current && current.inputs && current.inputs[0]) current.inputs[0].focus();
  else gradeTyping();
}
function handleRefEnter(e, which) {
  if (waitingNext && e.key==="Enter") { e.preventDefault(); advanceNext(); return; }
  if (!current || !current.refQuiz) return;
  const masked = refFieldsMaskedOrder();
  if (masked.length === 0) { e.preventDefault(); focusFirstClozeOrGrade(); return; }
  const idx = masked.indexOf(which);
  if (idx === -1) { e.preventDefault(); focusFirstClozeOrGrade(); return; }
  if (idx < masked.length - 1) masked[idx+1].focus();
  else focusFirstClozeOrGrade();
  e.preventDefault();
}
[elBookInput, elChapInput, elVerseInput].forEach((inp)=>{
  inp.addEventListener("keydown", (e)=>{ if (e.key === "Enter") handleRefEnter(e, e.target); });
});

/* ===== ë Œë”/ë„¤ë¹„ ===== */
function renderCloze(masked, answers){
  elClozeHost.innerHTML=""; const parts=masked.split("(ã€€ã€€ã€€)"); const inputs=[];
  parts.forEach((seg,i)=>{
    elClozeHost.appendChild(document.createTextNode(seg));
    if(i<answers.length){
      const span=document.createElement("span"); span.className="blank";
      const inp=document.createElement("input"); inp.type="text"; inp.setAttribute("data-idx",i);
      span.appendChild(inp); elClozeHost.appendChild(span); inputs.push(inp);
      inp.addEventListener("keydown",(e)=>{
        if (waitingNext && e.key==="Enter"){ e.preventDefault(); advanceNext(); return; }
        if(e.key==="Enter"){
          if(i<inputs.length-1) inputs[i+1].focus(); else gradeTyping();
        }
        if(e.key==="ArrowRight"&&i<inputs.length-1){inputs[i+1].focus();}
        if(e.key==="ArrowLeft"&&i>0){inputs[i-1].focus();}
      });
    }
  });
  if(inputs[0]) inputs[0].focus(); return inputs;
}
function maskRefFields(ans){
  const fields=["book","chap","verse"];
  const k = Math.floor(Math.random()*3)+1;
  const pick=[...fields].sort(()=>Math.random()-0.5).slice(0,k);
  const mask={book:false,chap:false,verse:false}; pick.forEach(f=>mask[f]=true); return mask;
}
function setRefUI(mask, ans){
  function setField(masked, fixedEl, inputEl, val){
    if(masked){ fixedEl.classList.add("hidden"); inputEl.classList.remove("hidden"); inputEl.value=""; }
    else{ fixedEl.textContent = val; fixedEl.classList.remove("hidden"); inputEl.classList.add("hidden"); }
  }
  setField(mask.book, elBookFixed, elBookInput, ans.book);
  setField(mask.chap, elChapFixed, elChapInput, ans.chap);
  setField(mask.verse, elVerseFixed, elVerseInput, ans.verse);
}
function focusFirstMaskedRef(mask) {
  try {
    if (mask && mask.book) { elBookInput.focus(); return true; }
    if (mask && mask.chap) { elChapInput.focus(); return true; }
    if (mask && mask.verse) { elVerseInput.focus(); return true; }
  } catch(e){}
  return false;
}

/* ===== ì„¸ì…˜ (â­ï¸ ìˆ˜ì •ë¨) ===== */
function startStudy(){
  running=true;
  document.getElementById("startBtn").classList.add("hidden");
  document.getElementById("stopBtn").classList.remove("hidden");
  nextCard();
  show(elStudy);
}
function stopStudy(){
  running=false;
  document.getElementById("stopBtn").classList.add("hidden");
  document.getElementById("startBtn").classList.remove("hidden");
  show(null);
}

// â­ï¸ ìˆ˜ì •ëœ í•¨ìˆ˜: ë ˆë²¨ ê¸°ë°˜ ê´„í˜¸ ë¹„ìœ¨ ì ìš©
function nextCard(){
  if(!running) return;
  waitingNext=false; elNextBtn.classList.add("hidden");

  const pick=pickWeighted(); const card=pick.card;

  // 1. ì¹´ë“œì˜ SRS ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ í˜„ì¬ ë ˆë²¨ í™•ì¸
  //    (level ì†ì„±ì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ì´ˆê¸°í™”)
  const srsData = SRS[card.ref] || { level: 0, ef: 2.5, interval: 0, due: today() };
  if (typeof srsData.level === 'undefined') srsData.level = 0;
  const currentLevel = srsData.level;

  // 2. ë ˆë²¨ì— ë§ëŠ” ê´„í˜¸ ë¹„ìœ¨(maskRatio) ì„¤ì •
  const maskRatio = MASK_LEVELS[Math.min(currentLevel, MAX_LEVEL)];

  const refQuiz = Math.random() < REF_QUIZ_RATE;
  // 3. ë³¸ë¬¸ í€´ì¦ˆì¼ ë•Œë§Œ ë ˆë²¨ë³„ ê´„í˜¸ ë¹„ìœ¨(maskRatio)ì„ ì ìš©
  const ratio = refQuiz ? TEXT_MASK_RATIO_WHEN_REF : maskRatio;
  
  const {masked, answers} = makeCloze(card.text, ratio, currentLevel);
  current = {card, answers, masked, inputs:[], refQuiz, refMask:null, refAns:parseRef(card.ref)};

  elModeBadge.textContent = refQuiz ? "ì¥ì ˆ ì•”ê¸°" : "ë³¸ë¬¸ ì•”ê¸°";
  elModeLabel.textContent="íƒ€ì´í•‘";
  // 4. UIì— í˜„ì¬ ë ˆë²¨ í‘œì‹œ
  elWeightInfo.textContent = `ê°€ì¤‘ì¹˜ ${pick.weight.toFixed(3)} | ë ˆë²¨ ${currentLevel}`;

  elResult.innerHTML="";
  document.getElementById("refView").textContent = refQuiz ? "???" : card.ref;

  if(refQuiz){
    elRefQuizArea.classList.remove("hidden");
    current.refMask = maskRefFields(current.refAns);
    setRefUI(current.refMask, current.refAns);
  }else{
    elRefQuizArea.classList.add("hidden");
  }

  current.inputs = renderCloze(masked, answers);

  setTimeout(()=>{
    try{
      let focused=false;
      if(current && current.refQuiz){ focused = focusFirstMaskedRef(current.refMask); }
      if(!focused && current && current.inputs && current.inputs[0]){ current.inputs[0].focus(); focused=true; }
      if(!focused){ const sb=document.getElementById("submitBtn"); if(sb) sb.focus(); }
    }catch(e){}
  }, 0);
}

/* ===== í†µê³„/SRS ===== */
function recordStat(ref, ok){ const s=STATS[ref]||{seen:0,correct:0,wrong:0,last:null}; s.seen++; ok?s.correct++:s.wrong++; s.last=today(); STATS[ref]=s; save(KEY_STATS,STATS); updateHeader(); }

// â­ï¸ [ìš”ì²­ 1] ìˆ˜ì •ëœ SRS ì•Œê³ ë¦¬ì¦˜
// E-Factor ê³„ì‚°ì€ í•­ìƒ ìˆ˜í–‰í•˜ê³ , q ê°’ì— ë”°ë¼ intervalê³¼ due ë‚ ì§œë§Œ ë‹¤ë¥´ê²Œ ì„¤ì •
function srsUpdateLight(srsData, q){
  if (typeof srsData.level === 'undefined') srsData.level = 0; // ì•ˆì „ì¥ì¹˜

  // 1. E-Factor(í•™ìŠµ ìš©ì´ë„) ê°±ì‹  (SM-2 ì•Œê³ ë¦¬ì¦˜ ê³µì‹)
  // q=3ì¼ ë•Œ (0.1 - 2*...) = -0.064
  // q=3ì¼ ë•ŒëŠ” EFê°€ 0ì´ ë¨. (0.1 - (5-3)*(0.08+(5-3)*0.02)) = 0.1 - 2*(0.08+0.04) = 0.1 - 2*0.12 = 0.1 - 0.24 = -0.14
  // ê³µì‹ ìˆ˜ì •: (srsData.ef||2.5) + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
  srsData.ef = (srsData.ef || 2.5) + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02));
  if (srsData.ef < 1.3) srsData.ef = 1.3; // ìµœì†Œ EFëŠ” 1.3

  // 2. ë³µìŠµ ê°„ê²©(Interval) ë° ë‹¤ìŒ ë³µìŠµì¼(Due) ê°±ì‹ 
  if (q < 4) {
    // q=2 (ì˜¤ë‹µ) ë˜ëŠ” q=3 (ë¶€ë¶„ ì •ë‹µ/ë ˆë²¨ì—…)
    // í•™ìŠµ ê°„ê²©ì„ 0ìœ¼ë¡œ ë¦¬ì…‹í•˜ê³ , ì˜¤ëŠ˜ ë°”ë¡œ ë‹¤ì‹œ ë³µìŠµ
    srsData.interval = 0;
    srsData.due = today();
  } else {
    // q=4, 5 (ë§ˆìŠ¤í„°)
    // ë‹¤ìŒ ë³µìŠµ ê°„ê²© ê³„ì‚°
    if (!srsData.interval || srsData.interval === 0) srsData.interval = 1;
    else if (srsData.interval === 1) srsData.interval = 3;
    else srsData.interval = Math.round(srsData.interval * srsData.ef);

    const d = new Date();
    d.setDate(d.getDate() + srsData.interval);
    srsData.due = d.toISOString().slice(0, 10);
  }
  // srsDataê°€ ì§ì ‘ ìˆ˜ì •ë¨
}

/* ===== ì±„ì  (â­ï¸ ìˆ˜ì •ë¨) ===== */
// â­ï¸ [ìš”ì²­ 2] ì˜¤ë‹µ í‘œì‹œ ë¡œì§ì´ ê°œì„ ëœ ì±„ì  í•¨ìˆ˜
function gradeTyping(){
  if(!current) return;

  // --- 1. ë³¸ë¬¸ ë° ì¥ì ˆ ì±„ì  ---
  const parts = current.inputs.map(inp => inp.value.trim());
  let ok = 0;
  current.answers.forEach((a, i) => { if(normalize(a) === normalize(parts[i])) ok++; });

  let refOk = true;
  if(current.refQuiz){
    const needBook=current.refMask.book, needChap=current.refMask.chap, needVerse=current.refMask.verse;
    const ub=elBookInput.value.trim(), uc=elChapInput.value.trim(), uv=elVerseInput.value.trim();
    const ans=current.refAns;
    if(needBook){ const okb=normalizeRef(ub)===normalizeRef(ans.book); refOk = refOk && okb; }
    if(needChap){ const okc=normalizeRef(uc)===normalizeRef(ans.chap); refOk = refOk && okc; }
    if(needVerse){ const okv=normalizeRef(uv)===normalizeRef(ans.verse); refOk = refOk && okv; }
  }

  const fullCorrect = (ok === current.answers.length) && (!current.refQuiz || refOk);
  let html = ""; // ê²°ê³¼ HTML
  const cls = fullCorrect ? "ok" : ((ok > 0 || (current.refQuiz && refOk)) ? "warn" : "err");

  // â­ï¸ [ìš”ì²­ 2] ê°œì„ ëœ ì˜¤ë‹µ í‘œì‹œ
  if (fullCorrect) {
    html = `<div>ë³¸ë¬¸ ì •ë‹µ ${ok}/${current.answers.length}`;
    if (current.refQuiz) html += ` Â· ì¥ì ˆ â­•`;
    html += `</div>`;
  } else {
    // --- 1. ì¥ì ˆ ê²°ê³¼ (ìš”ì²­ëŒ€ë¡œ ìˆœì„œ ë³€ê²½: ì¥ì ˆ ë¨¼ì €) ---
    html = `<div class="p"><strong>[ì¥ì ˆ]</strong><br>`;
    const tempDiv = document.createElement("div"); // XSS ë°©ì§€
    
    if (current.refQuiz) {
      const ub=elBookInput.value.trim(), uc=elChapInput.value.trim(), uv=elVerseInput.value.trim();
      const ans=current.refAns;
      
      if (current.refMask.book) {
        const okb = normalizeRef(ub) === normalizeRef(ans.book);
        tempDiv.textContent = ub; const safeUb = tempDiv.innerHTML;
        html += `ì„±ê²½: ${okb ? `<span class="ok">${ans.book}</span>` : `<span class="err" title="ì…ë ¥: ${safeUb||'ì—†ìŒ'}">${ans.book}</span>`}<br>`;
      }
      if (current.refMask.chap) {
        const okc = normalizeRef(uc) === normalizeRef(ans.chap);
        tempDiv.textContent = uc; const safeUc = tempDiv.innerHTML;
        html += `ì¥: ${okc ? `<span class="ok">${ans.chap}</span>` : `<span class="err" title="ì…ë ¥: ${safeUc||'ì—†ìŒ'}">${ans.chap}</span>`}<br>`;
      }
      if (current.refMask.verse) {
        const okv = normalizeRef(uv) === normalizeRef(ans.verse);
        tempDiv.textContent = uv; const safeUv = tempDiv.innerHTML;
        html += `ì ˆ: ${okv ? `<span class="ok">${ans.verse}</span>` : `<span class="err" title="ì…ë ¥: ${safeUv||'ì—†ìŒ'}">${ans.verse}</span>`}`;
      }
    } else {
      html += `<span class="muted">${current.card.ref} (í€´ì¦ˆ ì•„ë‹˜)</span>`;
    }
    html += `</div><hr>`;

    // --- 2. ë³¸ë¬¸ ê²°ê³¼ (ìš”ì²­ëŒ€ë¡œ í•˜ì´ë¼ì´íŠ¸ ë°©ì‹ ì ìš©) ---
    html += `<div class="p"><strong>[ë³¸ë¬¸ ì •ë‹µ]</strong> (ì´ ${current.answers.length}ê°œ ì¤‘ ${ok}ê°œ ì •ë‹µ)<br>`;
    html += `<div class="cloze" style="white-space:pre-wrap; font-size: 1.0rem; line-height: 1.6;">`;
    // 'reconstructVerse' í—¬í¼ í•¨ìˆ˜ í˜¸ì¶œ (ì´ í•¨ìˆ˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì— ì •ì˜ë¨)
    html += reconstructVerse(current.masked, current.answers, current.inputs);
    html += `</div></div>`;
  }
  
  // --- 2. í†µê³„ ë° ë ˆë²¨/SRS ë¡œì§ (â­ï¸ ìˆ˜ì •ëœ ë¶€ë¶„) ---
  recordStat(current.card.ref, fullCorrect);

  const srsKey = current.card.ref;
  const srsData = SRS[srsKey] || { level: 0, ef: 2.5, interval: 0, due: today() };
  if (typeof srsData.level === 'undefined') srsData.level = 0; // ì•ˆì „ì¥ì¹˜

  let resultMsg = "";
  let q = 0; // SRSì— ì „ë‹¬í•  ì ìˆ˜(quality)

  if (fullCorrect) {
    const currentLevel = srsData.level;
    if (currentLevel < MAX_LEVEL) {
      srsData.level = currentLevel + 1;
      q = 3; // 'ë³´í†µ' ì ìˆ˜ (ë³µìŠµ ê°„ê²© 0ìœ¼ë¡œ ë¦¬ì…‹ë¨)
      resultMsg = `<br><span class="ok">ğŸ‰ ë ˆë²¨ ìƒìŠ¹! (Level ${srsData.level})</span>`;
    } else {
      // ìµœê³  ë ˆë²¨ ë„ë‹¬
      q = hintUsed ? 4 : 5; // 'ë†’ì€' ì ìˆ˜ (ë³µìŠµ ê°„ê²© ëŠ˜ì–´ë‚¨)
      resultMsg = `<br><span class="ok">âœ¨ ë§ˆìŠ¤í„°! (ë‹¤ìŒ ë³µìŠµì¼ì´ ê°±ì‹ ë©ë‹ˆë‹¤)</span>`;
    }
  } else {
    // --- 3. ì˜¤ë‹µ ---
    if (srsData.level > 0) {
      srsData.level = srsData.level - 1;
      resultMsg = `<br><span class="warn">ğŸ’§ ë ˆë²¨ í•˜ë½. (Level ${srsData.level})</span>`;
    } else {
      resultMsg = `<br><span class="err">ğŸ’§ (ë ˆë²¨ 0ì—ì„œ ì‹¤ìˆ˜)</span>`;
    }
    q = (ok > 0 || (current.refQuiz && refOk)) ? 3 : 2; // ë¶€ë¶„ ì •ë‹µ 3, ì™„ì „ ì˜¤ë‹µ 2
  }

  // â­ï¸ [Request 1] ìˆ˜ì •ëœ SRS ì•Œê³ ë¦¬ì¦˜ í˜¸ì¶œ
  srsUpdateLight(srsData, q); // srsData ê°ì²´ê°€ ì§ì ‘ ìˆ˜ì •ë¨
  
  SRS[srsKey] = srsData;
  save(KEY_SRS, SRS);
  elResult.className="p "+cls;
  elResult.innerHTML = html + resultMsg; // ì±„ì  ê²°ê³¼ + ë ˆë²¨ ë³€ê²½ ë©”ì‹œì§€

  // --- 3. ì§„í–‰ ì œì–´ ---
  if(current.refQuiz && !refOk){ 
    // ì¥ì ˆ í€´ì¦ˆë¥¼ í‹€ë ¸ì„ ë•Œ, refViewì— ??? ëŒ€ì‹  ì •ë‹µì„ í‘œì‹œ
    document.getElementById("refView").textContent=current.card.ref; 
  }

  if (fullCorrect && q >= 4) { // ë§ˆìŠ¤í„°í•œ ê²½ìš° (q=4 ë˜ëŠ” 5)
    setTimeout(nextCard, 1000);
  } else if (fullCorrect && q < 4) { // ë ˆë²¨ì—… í•œ ê²½ìš° (q=3)
    setTimeout(nextCard, 800);
  } else {
    // ì˜¤ë‹µ ì‹œ (q=2 ë˜ëŠ” 3)
    elNextBtn.classList.remove("hidden");
    setTimeout(() => {
      waitingNext = true; 
    }, 0);
  }
}

/* ===== ì´ë²¤íŠ¸/í•«í‚¤ ===== */
function msg(el, html, cls=""){ el.className="p "+(cls||""); el.innerHTML=html; }

document.getElementById("startBtn").onclick=startStudy;
document.getElementById("stopBtn").onclick=stopStudy;
document.getElementById("listBtn").onclick=()=>{ 
  show(elList); 
  const el=document.getElementById("cardList"); 
  el.innerHTML=""; 
  // â­ï¸ ì¹´ë“œ ëª©ë¡ì— ë ˆë²¨ê³¼ ë³µìŠµì¼ í‘œì‹œ
  CARDS.forEach((c,i)=>{ 
    const st=STATS[c.ref]||{seen:0,correct:0,wrong:0}; 
    const sr=SRS[c.ref]||{level:0, due: 'N/A'};
    const div=document.createElement("div"); 
    div.className="p"; 
    div.innerHTML=`<strong>${i+1}. ${c.ref}</strong> 
      <small class="muted">Lvl:${sr.level||0} | Due:${sr.due||'N/A'} | seen:${st.seen||0} / ok:${st.correct||0} / ng:${st.wrong||0}</small>
      <br>${c.text}`; 
    el.appendChild(div); 
  }); 
};
document.getElementById("exportBtn").onclick=()=>{ const blob=new Blob([JSON.stringify({cards:CARDS,srs:SRS,stats:STATS},null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="bct-backup.json"; a.click(); };
document.getElementById("resetBtn").onclick=()=>{ if(!confirm("ëª¨ë“  ë°ì´í„°(cards/srs/stats)ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?")) return; localStorage.removeItem(KEY_CARDS); localStorage.removeItem(KEY_SRS); localStorage.removeItem(KEY_STATS); CARDS=defaultCards(); save(KEY_CARDS,CARDS); SRS={}; STATS={}; updateHeader(); alert("ì´ˆê¸°í™” ì™„ë£Œ"); };

document.getElementById("submitBtn").onclick=gradeTyping;
document.getElementById("nextBtn").onclick=advanceNext;
document.getElementById("hintFirst").onclick=()=>{ hintUsed=true; const t=current.answers.map(a=>a[0]+"_".repeat(Math.max(0,a.length-1))).join(" | "); msg(elResult,"íŒíŠ¸(ì²«ê¸€ì): "+t,"muted"); };
document.getElementById("hintLen").onclick=()=>{ hintUsed=true; msg(elResult,"íŒíŠ¸(ê¸¸ì´): "+current.answers.map(a=>a.length).join(" | "),"muted"); };
document.getElementById("hintReveal").onclick=()=>{ hintUsed=true; const i=Math.floor(Math.random()*current.answers.length); if(current.inputs[i]) current.inputs[i].value=current.answers[i]; msg(elResult,`ë¶€ë¶„ ê³µê°œ: ${current.answers.map((a,idx)=> idx===i?a:"_".repeat(a.length)).join(" | ")}`,"muted"); };
document.getElementById("switchSelf").onclick=()=>{ elModeLabel.textContent="ì…€í”„"; document.getElementById("typingArea").classList.add("hidden"); document.getElementById("selfArea").classList.remove("hidden"); const el=document.getElementById("fullAnswer"); el.classList.add("hidden"); elResult.innerHTML=""; };
document.getElementById("showAnswerQuick").onclick=()=>{ elModeLabel.textContent="ì…€í”„"; document.getElementById("typingArea").classList.add("hidden"); document.getElementById("selfArea").classList.remove("hidden"); const el=document.getElementById("fullAnswer"); el.textContent=`[${current.card.ref}] ${current.card.text}`; el.classList.remove("hidden"); };
document.getElementById("switchTyping").onclick=()=>{ elModeLabel.textContent="íƒ€ì´í•‘"; document.getElementById("typingArea").classList.remove("hidden"); document.getElementById("selfArea").classList.add("hidden"); elResult.innerHTML=""; };
document.getElementById("showAnswer").onclick=()=>{ const el=document.getElementById("fullAnswer"); el.textContent=`[${current.card.ref}] ${current.card.text}`; el.classList.remove("hidden"); };

// â­ï¸ ì…€í”„ ì±„ì ë„ ë ˆë²¨ ì‹œìŠ¤í…œê³¼ ì—°ë™
document.getElementById("selfSubmit").onclick=()=>{ 
  const val=parseInt(document.getElementById("selfScore").value||"3",10); 
  const q=Math.min(5,Math.max(1,val)); 
  recordStat(current.card.ref, q>=4); 
  
  const srsKey = current.card.ref;
  const srsData = SRS[srsKey] || { level: 0, ef: 2.5, interval: 0, due: today() };
  if (typeof srsData.level === 'undefined') srsData.level = 0;

  if (q >= 4) { // 4, 5ì  (ì •ë‹µ)
    const currentLevel = srsData.level;
    if (currentLevel < MAX_LEVEL) {
      srsData.level = currentLevel + 1;
      srsUpdateLight(srsData, 3); // q=3 (ë ˆë²¨ì—…)
    } else {
      srsUpdateLight(srsData, q); // q=4 or 5 (ë§ˆìŠ¤í„°)
    }
  } else { // 1, 2, 3ì  (ì˜¤ë‹µ)
    if (srsData.level > 0) {
      srsData.level = srsData.level - 1;
    }
    srsUpdateLight(srsData, q < 3 ? 2 : 3); // q=1,2 -> 2 / q=3 -> 3
  }
  
  SRS[srsKey] = srsData;
  save(KEY_SRS, SRS); 
  nextCard(); 
};

document.addEventListener("keydown",(e)=>{
  // ì˜¤ë‹µ ì´í›„: Enter ëˆ„ë¥´ë©´ ë¬´ì¡°ê±´ ë‹¤ìŒ
  if (waitingNext && e.key==="Enter"){ e.preventDefault(); advanceNext(); return; }
  // ì…€í”„ ëª¨ë“œì—ì„œ Enter -> ê¸°ë¡
  if(e.key==="Enter" && !document.getElementById("selfArea").classList.contains("hidden")){
    e.preventDefault(); document.getElementById("selfSubmit").click();
  }
});
</script><script>
// === Global Hotkeys (work in inputs) + Focus/Caret Preservation ===
// Keys:
//   Not typing: H / L / R
//   Typing in input/textarea/contenteditable: Alt+Shift+H / Alt+Shift+L / Alt+Shift+R
//   Always available: F1=Hint, F2=Line, F3=Reveal
// After action: original focus & caret are restored.

(function(){
  function isTextField(el){
    if(!el) return false;
    const tag = el.tagName ? el.tagName.toLowerCase() : "";
    return tag === "input" || tag === "textarea" || el.isContentEditable;
  }

  function preserveFocus(){
    const el = document.activeElement;
    let sel = null;
    try {
      if (el && (el.tagName === "INPUT" || el.tagName === "TEXTAREA")) {
        sel = {start: el.selectionStart, end: el.selectionEnd};
      }
    } catch(e){}
    return {el, sel};
  }

  function restoreFocus(state){
    if(!state || !state.el) return;
    setTimeout(()=>{
      try{
        state.el.focus({preventScroll:true});
        if(state.sel && typeof state.sel.start === "number" && typeof state.sel.end === "number"){
          state.el.setSelectionRange(state.sel.start, state.sel.end);
        }
      }catch(e){}
    }, 0);
  }

  function clickById(id){
    const el = document.getElementById(id);
    if (el) { el.click(); return true; }
    return false;
  }

  function triggerAction(action){
    // Map actions to concrete button IDs in this app
    const idMap = { hint: "hintFirst", line: "hintLine", reveal: "hintReveal" };
    if (clickById(idMap[action])) return true;

    // Fallbacks
    if (typeof window.doHint === "function" && action==="hint") { window.doHint(); return true; }
    if (typeof window.doLine === "function" && action==="line") { window.doLine(); return true; }
    if (typeof window.doReveal === "function" && action==="reveal") { window.doReveal(); return true; }

    // Text search fallback (less reliable)
    const labelMap = { hint: "H(", line: "L(", reveal: "R(" };
    const btn = Array.from(document.querySelectorAll("button")).find(b => (b.textContent||"").includes(labelMap[action]));
    if (btn) { btn.click(); return true; }

    return false;
  }

  // Keep buttons from stealing focus
  document.addEventListener("mousedown", (e)=>{
    const t = e.target;
    if (t && (t.tagName||"").toLowerCase()==="button"){
      e.preventDefault();
      t.click();
    }
  }, true);

  document.addEventListener("keydown", (e)=>{
    const key = (e.key||"").toLowerCase();
    const typing = isTextField(document.activeElement);

    // Determine desired action
    let action = null;

    // Function keys: F1/F2/F3 (always on)
    if (e.key === "F1") action = "hint";
    else if (e.key === "F2") action = "line";
    else if (e.key === "F3") action = "reveal";

    // Plain keys when not typing
    if (!action && !typing){
      if (key === "h") action = "hint";
      else if (key === "l") action = "line";
      else if (key === "r") action = "reveal";
    }

    // When typing: require Alt+Shift to avoid interfering with input text
    if (!action && typing && e.altKey && e.shiftKey){
      if (key === "h") action = "hint";
      else if (key === "l") action = "line";
      else if (key === "r") action = "reveal";
    }

    if (!action) return;

    // Preserve focus/caret and execute
    const state = preserveFocus();
    e.preventDefault();
    e.stopPropagation();
    triggerAction(action);
    restoreFocus(state);
  }, true);
})();
</script>
</body>
</html>
